<?php
namespace {{ class.namespace }}\AccessLayer\Base;

use Gone\SDK\Common\Abstracts\HttpAccessLayer;
use Gone\SDK\Common\Exceptions;
use {{ class.namespace }}\Models;
use Gone\SDK\Common\Filters\Filter;
{% set hasUpdate = false %}
{% set hasCreate = false %}
abstract class Base{{ class.name }}AccessLayer extends HttpAccessLayer
{
{% for method in class.methods %}
{% if method.function == "update" %}
{% set hasUpdate = true %}
{% include "SDK/AccessLayer/_function_create_update.php.twig" with {'methodName':'update','class':class,'method':method} %}
{% elseif method.function == "create" %}
{% set hasCreate = true %}
{% include "SDK/AccessLayer/_function_create_update.php.twig" with {'methodName':'create','class':class,'method':method} %}
{% else %}
    /**
{% for name, argument in method.arguments %}
     * @param {{ argument.phpType }} ${{ name }}
{% endfor %}
     *
{% if method.responseKey %}
     * @return Models\{{ method.responseClass }}Model{{ method.returnsArray ? '[]' : '' }}|null
{% else %}
     * @return array|null
{% endif %}
     * @throws Exceptions\SDKException
     */
    public function {{ method.function }}(
{% for name, argument in method.arguments %}
{% if argument.required %}
        {{ argument.phpType }} ${{ name }}{{ loop.last ? '' : ',' }}
{% else %}
        {{ argument.phpType }} ${{ name }} = {{ argument.default|json_encode()|raw }}{{ loop.last ? '' : ',' }}
{% endif %}
{% endfor %}
    ){
        $endpoint = "{{ method.pattern }}";
        $options = [];

{% if method.groupedArguments.query %}
{% include "SDK/AccessLayer/_method_args.php.twig" with {'name':'queryArgs','args':method.groupedArguments.query} %}
        $endpoint = $this->replaceUrlElements($endpoint,$queryArgs);
{% endif %}
{% if method.groupedArguments.body %}
{% include "SDK/AccessLayer/_method_args.php.twig" with {'name':'bodyArgs','args':method.groupedArguments.body} %}
        $options["body"] = $bodyArgs;
{% endif %}
{% if method.groupedArguments.header %}
{% include "SDK/AccessLayer/_method_args.php.twig" with {'name':'headerArgs','args':method.groupedArguments.header} %}
        $options["headers"] = $headerArgs;
{% endif %}

        $response = $this->request(
            "{{ method.method }}",
            $endpoint,
            $options
        );
{% if method.responseKey %}
        $data = $response["{{ method.responseKey }}"];
        return $this->hydrate{{ method.returnsArray ? 'Many' : '' }}(Models\{{ method.responseClass }}Model::class,$data);
{% else %}
        return $response;
{% endif %}
    }
{% endif %}
{% endfor %}

{% if hasUpdate or hasCreate %}
    public function save(Models\{{ class.name }}Model ${{ class.variable }})
    {
        $pks = ${{ class.variable }}->getPrimaryKeys();
        $pkCount = count($pks);
        $pks = array_filter($pks);
        {% if hasUpdate %}
        if(count($pks) == $pkCount){
            $this->update(${{ class.variable }});
        }
        {% endif %}
        {% if hasCreate %}
        $this->create(${{ class.variable }});
        {% endif %}
    }
{% endif %}
}