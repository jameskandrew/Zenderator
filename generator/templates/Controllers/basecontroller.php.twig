<?php
namespace {{ class.namespace }}\Controllers\Base;

use Gone\SDK\Common\Filters\Filter;
use Gone\SDK\Common\Filters\FilterCondition;
use Gone\AppCore\Abstracts\CrudController as AbstractCrudController;
use \{{ class.namespace }}\Services;
use \{{ class.namespace }}\Models;
use Slim\Http\Request;
use Slim\Http\Response;

{% include '_overwrite_warning.twig' %}

abstract class Base{{ class.name }}Controller extends AbstractCrudController
{
    const RESPONSIBLE_MODEL = Model\{{ class.name }}Model::class;

    protected $singularTerm = Model\{{ class.name }}Model::NAME_SINGULAR;
    protected $pluralTerm = Model\{{ class.name }}Model::NAME_SINGULAR;

{% for related in class.relatedData %}
    /** @var Services\{{ related.getRemoteService }} */
    protected ${{ related.getRemoteServiceLC }};
{% endfor %}

    /**
     * @param Services\{{ class.name }}Service ${{ class.variable }}
     */
    public function __construct(
        Services\{{ class.name }}Service ${{ class.variable }}
{% for related in class.relatedData %}
        ,Services\{{ related.getRemoteService }} ${{ related.getRemoteServiceLC }}
{% endfor %}
    )
    {
        $this->service = ${{ class.variable }};
{% for related in class.relatedData %}
        $this->{{ related.getRemoteServiceLC }} = ${{ related.getRemoteServiceLC }};
{% endfor %}
    }

    /**
     * @returns Services\{{ class.name }}Service
     */
    public function getService() : Services\{{ class.name }}Service
    {
        return parent::getService();
    }

{% for related in class.relatedObjects %}
    public function {{ related.getBoundModelReferenceNameLC }}Request(Request $request, Response $response, $args) : Response
    {
{% for key in class.primaryKeys %}
        ${{ key }} = $args['{{ key }}'];
{% endfor %}
        ${{ related.getBoundModelReferenceNameLC }} = $this->{{ related.getRemoteServiceLC }}->get(
            Filter::Factory()
                ->addJoin(
                    Models\{{ class.name }}Model::FIELD_{{ related.getLocalBoundColumn|upper }},
                    Models\{{ class.name }}Model::TABLE_NAME,
                    Models\{{ related.getRemoteModel }}::FIELD_{{ related.getRemoteBoundColumn|upper }}
                )
{% for key in class.primaryKeys %}
                ->addWhere(
                    Models\{{ class.name }}Model::FIELD_{{ key|upper }},
                    ${{ key }},
                    FilterCondition::CONDITION_EQUAL,
                    Models\{{ class.name }}Model::TABLE_NAME
                )
{% endfor %}
        );
        if (${{ related.getBoundModelReferenceNameLC }}) {
            return $this->jsonSuccessResponse(
                [
                    'Action'                          => 'GET_{{ related.getBoundModelReferenceName|upper }}',
                    Models\{{ related.getRemoteModel }}::NAME_SINGULAR => ${{ related.getBoundModelReferenceNameLC }}->__toArray(),
                ],
                $request,
                $response
            );
        }
        return $this->jsonFailureResponse(
            sprintf(
                "No such related %s found for %s with id %s",
                strtolower(Models\{{ related.getRemoteModel }}::NAME_SINGULAR),
                strtolower(Models\{{ class.name }}Model::NAME_SINGULAR),
                $args['id']
            ),
            $request,
            $response
        );
    }

{% endfor %}
}
