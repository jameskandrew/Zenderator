<?php
namespace {{ class.namespace }}\Validators\Base;

use Gone\AppCore\Validator\AbstractValidator;
use Gone\AppCore\Validator\ValidatorRule;
use Gone\AppCore\Validator\ValidatorRuleCollection;
use Gone\AppCore\Validator\Rules\ForeignKeyRule;
use {{ class.namespace }}\AccessLayers;
use {{ class.namespace }}\Models;
use Respect\Validation\Validator;

abstract class Base{{ class.name }}Validator extends AbstractValidator
{
{% if not class.relatedClasses is empty %}

{% for var, class in class.relatedClasses %}
    /** @var AccessLayers\{{ class }}AccessLayer */
    private ${{ var }}AccessLayer;
{% endfor %}

    public function __construct(
{% for var, class in class.relatedClasses %}
        AccessLayers\{{ class }}AccessLayer ${{ var }}AccessLayer{{ loop.last ? '' : ',' }}
{% endfor %}
    ){
{% for var, class in class.relatedClasses %}
        $this->{{ var }}AccessLayer = ${{ var }}AccessLayer;
{% endfor %}
    }
{% endif %}

    public function getRules() : ValidatorRuleCollection
    {
        return ValidatorRuleCollection::Factory()
{% if class.conditions %}
{% for condition in class.conditions %}
            ->addRule(
{#//              {{ condition|json_encode()|raw }}#}
                ValidatorRule::Factory()
                    ->setFields({{ condition.fields|json_encode()|raw }})
{% if condition.type == "foreignKey" %}
                    ->setRule(new ForeignKeyRule($this->{{ condition.variable }}AccessLayer,Models\{{ condition.class }}Model::FIELD_{{ condition.foreign|upper }}))
{% elseif condition.type == "unique" %}
                    ->setRule(new ForeignKeyRule())
{% else %}
                    ->setRule({{ condition.required ? '' : 'Validator::optional(' }}{% if condition.type == "string" %}Validator::stringType()->length({{ condition.required ? '1' : '0' }}, {{ condition.length is defined ? condition.length : 'null' }}){% elseif condition.type == "int" or condition.type == "float" %}Validator::{{ condition.type }}Type(){% if condition.min is defined %}->min({{ condition.min }}){% endif %}{% if condition.max is defined %}->min({{ condition.max }}){% endif %}{% elseif condition.type == "enum" %}Validator::in({{ condition.options|json_encode()|raw }}){% endif %}{{ condition.required ? "" : ")" }})
{% if not condition.required %}
                    ->setScenario(AbstractValidator::SCENARIO_ALL)
{% endif %}
{% endif %},
                "{{ condition.key }}"
            )
{% endfor %}
{% endif %};
    }
}