<?php

namespace {{ class.namespace }}\Services\Base;

use Gone\AppCore\Abstracts\Service as AbstractService;
use Gone\AppCore\Interfaces\ServiceInterface as ServiceInterface;
use Gone\SDK\Common\Abstracts\AbstractModel;
use Gone\SDK\Common\Filters\Filter;
use Gone\SDK\Common\Filters\FilterCondition;
use \{{ class.namespace }}\AccessLayers;
use \{{ class.namespace }}\Models;
use Zend\Db\ResultSet\ResultSet;
use Zend\Db\Sql\Select;

{% set SKIP_ARGS = config.routes.skip_argument %}

{% set HAS_SKIP_ARG = false %}
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
{% set HAS_SKIP_ARG = true %}
{% endif %}
{% endfor %}

{% include '_overwrite_warning.twig' %}

// @todo: Make all Services implement a ServicesInterface
abstract class Base{{ class.name }}Service
    extends AbstractService
//    implements ServiceInterface
{

    protected $modelClass = Models\{{ class.name }}Model::class;

{% if class.foreignClasses %}
    // Remote & Related Objects Table Access Layers
{% for variable,foreign in class.foreignClasses %}
{% if foreign != class.name %}
    /** @var AccessLayers\{{ foreign }}AccessLayer */
    protected ${{ variable }}AccessLayer;
{% endif %}
{% endfor %}

{% endif %}

    public function __construct(
{% for variable,foreign in class.foreignClasses %}
{% if foreign != class.name %}
        AccessLayers\{{ foreign }}AccessLayer ${{ variable }}AccessLayer,
{% endif %}
{% endfor %}
        AccessLayers\{{ class.name }}AccessLayer ${{ class.variable }}AccessLayer
    )
    {
{% for variable,foreign in class.foreignClasses %}
{% if foreign != class.name %}
        $this->{{ variable }}AccessLayer = ${{ variable }}AccessLayer;
{% endif %}
{% endfor %}
        parent::__construct(${{ class.variable }}AccessLayer);
    }

    public function getByPK($pk){
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
        $_pk[Models\{{ class.name }}Model::FIELD_{{ arg|upper }}] = $this->get{{ class.properties[arg].name }}();
{% endif %}
{% endfor %}
        $_pk = [];
        foreach($pk as $property => $value){
            if(in_array($property,Models\{{ class.name }}Model::PRIMARY_KEYS)){
                $_pk[$property] = $value;
            }
        }
        return parent::getByPK($_pk);
    }

{% if HAS_SKIP_ARG %}
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
    abstract protected function get{{ class.properties[arg].name }}();

{% endif %}
{% endfor %}
    public function save(AbstractModel ${{ class.variable }})
    {
        /** @var Models\{{ class.name }}Model ${{ class.variable }} */
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
        ${{ class.variable }}->set{{ class.properties[arg].name }}($this->get{{ class.properties[arg].name }}());
{% endif %}
{% endfor %}
        return parent::save(${{ class.variable }});
    }

    public function get(Filter $filter)
    {
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
        $filter->addWhere(Models\{{ class.name }}Model::FIELD_{{ arg|upper }}, $this->get{{ class.properties[arg].name }}());
{% endif %}
{% endfor %}
        return parent::get($filter);
    }

    public function getAll(Filter $filter): array
    {
{% for arg in SKIP_ARGS %}
{% if arg in class.properties|keys %}
        $filter->addWhere(Models\{{ class.name }}Model::FIELD_{{ arg|upper }}, $this->get{{ class.properties[arg].name }}());
{% endif %}
{% endfor %}
        return parent::getAll($filter);
    }

{% endif %}
{% for related in class.relatedData %}
{% if loop.first %}
    //Related Data
{% endif %}
{% for field in related.fields %}
    public function get{{ field.related.variableUC }}($pks)
    {
        return $this->{{ related.class.variable }}AccessLayer->get(
            Filter::Factory(Models\{{ related.class.name }}Model::TABLE_NAME)
                ->addJoin(
                    Models\{{ class.name }}Model::FIELD_{{ field.local.name|upper }},
                    Models\{{ class.name }}Model::TABLE_NAME,
                    Models\{{ related.class.name }}Model::FIELD_{{ field.related.name|upper }},
                    Models\{{ related.class.name }}Model::TABLE_NAME
                )
{% for key in class.primaryKeys %}
                ->addWhere(
                    Models\{{ class.name }}Model::FIELD_{{ key|upper }},
                    $pks[Models\{{ class.name }}Model::FIELD_{{ key|upper }}],
                    FilterCondition::CONDITION_EQUAL,
                    Models\{{ class.name }}Model::TABLE_NAME
                )
{% endfor %}
        );
    }

{% endfor %}
{% endfor %}


{% for remote in class.remoteData %}
{% if loop.first %}
    //Remote Data
{% endif %}
{% for field in remote.fields %}
    public function get{{ field.remote.variablePluralUC }}($pks, Filter $filter)
    {
        $filter
            ->addJoin(
                Models\{{ class.name }}Model::FIELD_{{ field.local.name|upper }},
                Models\{{ class.name }}Model::TABLE_NAME,
                Models\{{ remote.class.name }}Model::FIELD_{{ field.remote.name|upper }},
                Models\{{ remote.class.name }}Model::TABLE_NAME
            )
{% for key in class.primaryKeys %}
            ->addWhere(
                Models\{{ class.name }}Model::FIELD_{{ key|upper }},
                $pks[Models\{{ class.name }}Model::FIELD_{{ key|upper }}],
                FilterCondition::CONDITION_EQUAL,
                Models\{{ class.name }}Model::TABLE_NAME
            ){{ loop.last ? ';' : '' }}
{% endfor %}
        return $this->{{ remote.class.variable }}AccessLayer->getAll($filter);
    }

{% endfor %}
{% endfor %}
}